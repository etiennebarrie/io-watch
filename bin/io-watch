#!/usr/bin/env ruby

require 'console'
require 'io/watch'

command = ARGV
pid = nil
signal = :INT

if command.first =~ /TERM|INT|KILL|QUIT|HUP/
	signal = command.shift
end

if split = command.index('--')
	roots = command.pop(split)
	command.pop
else
	roots = [Dir.pwd]
end

monitor = IO::Watch::Monitor.new(roots)

monitor.run do
	if pid
		Console.info(self, "Killing command...", pid: pid)
		Process.kill(signal, pid)
		Process.wait(pid)
	end
	
	Console.info(self, "Starting command...")
	pid = Process.spawn(*command)
	Console.info(self, "Started command", pid: pid)
end
